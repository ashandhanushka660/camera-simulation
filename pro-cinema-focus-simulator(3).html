<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pro Cinema Focus Simulator - Ultra Realistic</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        // Suppress Tailwind CDN warning
        if (typeof console !== 'undefined') {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            touch-action: none;
        }

        #canvas-wrap {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        canvas {
            display: block;
            cursor: grab;
            touch-action: none;
        }

        canvas:active {
            cursor: grabbing;
        }

        .viewfinder-hud {
            position: absolute;
            inset: 0;
            pointer-events: none;
            border: 38px solid rgba(0, 0, 0, 0.85);
            box-sizing: border-box;
            z-index: 10;
            display: none;
        }

        .digital-text {
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 1px 1px 3px #000;
        }

        .rec-dot {
            width: 14px;
            height: 14px;
            background: #ef4444;
            border-radius: 50%;
            display: inline-block;
            animation: blink 1.2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .focus-crosshair {
            position: absolute;
            inset: 0;
            margin: auto;
            width: 70px;
            height: 70px;
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            pointer-events: none;
        }

        .focus-crosshair::before,
        .focus-crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.4);
        }

        .focus-crosshair::before {
            width: 20px;
            height: 1.5px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .focus-crosshair::after {
            width: 1.5px;
            height: 20px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .wheel-ui {
            width: 160px;
            height: 160px;
            border: 6px solid #1e293b;
            border-radius: 50%;
            background: radial-gradient(circle at 50% 50%, #334155, #0f172a);
            cursor: grab;
            position: relative;
            touch-action: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            user-select: none;
        }

        .wheel-ui:active {
            cursor: grabbing;
        }

        .wheel-mark {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 28px;
            background: #ef4444;
            border-radius: 3px;
            box-shadow: 0 0 12px #ef4444;
            transform-origin: 50% 72px;
        }

        .mode-overlay {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
            backdrop-filter: blur(8px);
        }

        input[type=range] {
            -webkit-appearance: none;
            height: 6px;
            background: #475569;
            border-radius: 3px;
            width: 100%;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #1e293b;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #1e293b;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
        }

        .histogram {
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .histogram-bar {
            position: absolute;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
        }

        .zebra-overlay {
            position: absolute;
            inset: 38px;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 3px,
                rgba(255, 0, 0, 0.3) 3px,
                rgba(255, 0, 0, 0.3) 6px
            );
            display: none;
            animation: zebra-scroll 0.5s linear infinite;
        }

        @keyframes zebra-scroll {
            from { background-position: 0 0; }
            to { background-position: 0 6px; }
        }

        .focus-peaking {
            position: absolute;
            inset: 38px;
            pointer-events: none;
            mix-blend-mode: screen;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .focus-peaking.active {
            opacity: 1;
        }

        .waveform {
            width: 120px;
            height: 80px;
            background: rgba(0, 0, 0, 0.7);
            position: relative;
        }

        @media (max-width: 768px) {
            .wheel-ui {
                width: 130px;
                height: 130px;
            }

            .wheel-mark {
                transform-origin: 50% 58px;
                height: 24px;
            }

            #focus-controls {
                padding: 12px;
            }

            button {
                padding: 10px 14px !important;
                font-size: 10px !important;
            }
        }
    </style>
</head>

<body>

    <div id="canvas-wrap">

        <!-- Park View Mode Label -->
        <div id="park-mode-label" class="mode-overlay digital-text text-xs bg-slate-800/90 text-white px-6 py-2.5 rounded-full border border-slate-600 uppercase tracking-widest font-bold shadow-xl backdrop-blur-md">
            MODE: <span class="text-blue-400">PARK VIEW</span>
        </div>

        <div class="mode-overlay digital-text text-xs bg-white/80 text-slate-900 px-6 py-2.5 rounded-full border border-black/20 uppercase tracking-widest font-bold shadow-xl backdrop-blur-md hidden" id="cameraman-mode-label">
            VIEW: <span id="view-label" class="text-blue-700">CAMERAMAN POV</span>
        </div>

        <div id="hud" class="viewfinder-hud">
            <!-- Top Left: Camera Info -->
            <div class="absolute top-5 left-5 flex gap-5 items-center digital-text text-black text-xs font-bold">
                <div class="border border-black/60 px-3 py-1 bg-white/30">4K RAW</div>
                <div class="flex items-center gap-2">
                    <div class="w-10 h-5 border border-black/50 relative p-0.5">
                        <div id="battery-level" class="bg-green-600 h-full w-[94%] transition-all"></div>
                    </div>
                    <span id="battery-pct">94%</span>
                </div>
                <div class="border border-black/60 px-3 py-1 bg-white/30">
                    <span id="fps-counter">24.0 fps</span>
                </div>
            </div>

            <!-- Top Right: Recording -->
            <div class="absolute top-5 right-5 flex items-center gap-2 digital-text font-bold">
                <span class="rec-dot"></span>
                <span class="text-red-600 text-base tracking-widest">REC</span>
            </div>

            <!-- Center: Focus Crosshair -->
            <div class="focus-crosshair"></div>

            <!-- Bottom Left: Camera Settings -->
            <div class="absolute bottom-5 left-5 digital-text text-xs space-y-1.5 text-black font-bold">
                <div>ISO <span id="iso-val">100</span></div>
                <div>WB: <span id="wb-val">5600</span>K</div>
                <div><span id="shutter-val">180</span>¬∞ SHUTTER</div>
                <div>LUT: <span id="lut-val">Rec.709</span></div>
            </div>

            <!-- Bottom Right: Timecode -->
            <div class="absolute bottom-5 right-5 digital-text text-2xl font-bold tracking-widest text-black">
                <span id="tc">00:00:00:00</span>
            </div>

            <!-- Bottom Center: Focus Bar -->
            <div class="absolute bottom-14 left-1/2 -translate-x-1/2 w-80 flex flex-col items-center">
                <div class="w-full h-1 bg-black/30 relative rounded">
                    <div id="focus-ptr" class="absolute -top-1.5 w-3 h-5 bg-red-600 transition-all duration-150 shadow-lg" style="left:50%"></div>
                </div>
                <div class="mt-3 text-xs digital-text tracking-wider text-black font-bold">
                    FOCUS: <span id="dist-label">5.0</span>m | DoF: <span id="dof-label">0.8</span>m
                </div>
            </div>

            <!-- Top Center: Histogram -->
            <div class="absolute top-5 left-1/2 -translate-x-1/2">
                <div class="histogram" id="histogram"></div>
            </div>

            <!-- Zebra Pattern Overlay -->
            <div id="zebra-overlay" class="zebra-overlay"></div>

            <!-- Focus Peaking Canvas -->
            <canvas id="peaking-canvas" class="focus-peaking"></canvas>
        </div>

        <!-- Control Panel -->
        <div class="absolute right-6 top-1/2 -translate-y-1/2 space-y-6 z-50">
            <button id="btn-mode" class="bg-blue-600 text-white font-black py-4 px-10 rounded-xl text-sm shadow-2xl hover:scale-105 active:scale-95 transition-all uppercase tracking-wider border-b-4 border-blue-800">
                Enter Cameraman Mode
            </button>
            
            <button id="btn-settings" class="bg-slate-800 text-white font-black py-4 px-10 rounded-xl text-sm shadow-2xl hover:scale-105 active:scale-95 transition-all uppercase tracking-wider border-b-4 border-black">
                Camera Settings
            </button>

            <div id="focus-controls" class="hidden flex flex-col items-center space-y-6 bg-white/70 p-6 rounded-2xl backdrop-blur-xl border border-white/40 shadow-2xl max-h-[85vh] overflow-y-auto">
                
                <!-- Follow Focus Wheel -->
                <div class="flex flex-col items-center">
                    <span class="text-xs uppercase tracking-widest text-slate-900 mb-3 font-black">FOLLOW FOCUS</span>
                    <div id="ff-wheel" class="wheel-ui">
                        <div id="wheel-mark" class="wheel-mark"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-xs text-slate-300 font-bold pointer-events-none">
                            ROTATE
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-3 w-full">
                    <button id="btn-rack" class="bg-blue-700 hover:bg-blue-800 text-white text-xs font-bold py-3.5 rounded-lg uppercase tracking-widest shadow-md transition">
                        Rack Focus
                    </button>
                    <button id="btn-autofocus" class="bg-green-700 hover:bg-green-800 text-white text-xs font-bold py-3.5 rounded-lg uppercase tracking-widest shadow-md transition">
                        Auto Focus
                    </button>
                </div>

                <!-- Visual Aids -->
                <div class="w-full space-y-2">
                    <div class="text-xs text-slate-900 font-black uppercase text-center border-b border-slate-400 pb-2">Visual Aids</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-peak" class="border-2 border-slate-800 text-xs py-2.5 rounded-lg text-slate-900 font-bold hover:bg-slate-800 hover:text-white transition uppercase tracking-widest">
                            Peaking
                        </button>
                        <button id="btn-zebra" class="border-2 border-slate-800 text-xs py-2.5 rounded-lg text-slate-900 font-bold hover:bg-slate-800 hover:text-white transition uppercase tracking-widest">
                            Zebras
                        </button>
                    </div>
                </div>

                <!-- Camera Controls -->
                <div class="pt-4 border-t border-slate-400 w-full space-y-5">
                    <div class="text-xs text-blue-900 font-black uppercase text-center">Camera Controls</div>

                    <!-- Aperture -->
                    <div>
                        <div class="flex justify-between text-xs mb-1.5 font-bold text-slate-900 uppercase">
                            <span>IRIS (F-Stop)</span>
                            <span id="val-fstop" class="text-blue-700">f/4.0</span>
                        </div>
                        <input type="range" id="input-fstop" min="1.4" max="22" step="0.1" value="4.0">
                    </div>

                    <!-- Focal Length -->
                    <div>
                        <div class="flex justify-between text-xs mb-1.5 font-bold text-slate-900 uppercase">
                            <span>FOCAL LENGTH</span>
                            <span id="val-zoom" class="text-blue-700">50mm</span>
                        </div>
                        <input type="range" id="input-zoom" min="16" max="200" step="1" value="50">
                    </div>

                    <!-- ISO -->
                    <div>
                        <div class="flex justify-between text-xs mb-1.5 font-bold text-slate-900 uppercase">
                            <span>ISO</span>
                            <span id="val-iso" class="text-blue-700">100</span>
                        </div>
                        <input type="range" id="input-iso" min="100" max="6400" step="100" value="100">
                    </div>

                    <!-- Shutter Speed -->
                    <div>
                        <div class="flex justify-between text-xs mb-1.5 font-bold text-slate-900 uppercase">
                            <span>SHUTTER ANGLE</span>
                            <span id="val-shutter" class="text-blue-700">180¬∞</span>
                        </div>
                        <input type="range" id="input-shutter" min="45" max="360" step="45" value="180">
                    </div>

                    <!-- White Balance -->
                    <div>
                        <div class="flex justify-between text-xs mb-1.5 font-bold text-slate-900 uppercase">
                            <span>WHITE BALANCE</span>
                            <span id="val-wb" class="text-blue-700">5600K</span>
                        </div>
                        <input type="range" id="input-wb" min="2800" max="10000" step="100" value="5600">
                    </div>

                    <!-- Shutter Speed -->
                    <div>
                        <div class="flex justify-between text-xs mb-1.5 font-bold text-slate-900 uppercase">
                            <span>SHUTTER SPEED</span>
                            <span id="val-shutter-speed" class="text-blue-700">1/50</span>
                        </div>
                        <input type="range" id="input-shutter-speed" min="24" max="8000" step="1" value="50">
                    </div>

                    <!-- Aspect Ratio -->
                    <div>
                        <div class="flex justify-between text-xs mb-1.5 font-bold text-slate-900 uppercase">
                            <span>ASPECT RATIO</span>
                            <span id="val-aspect" class="text-blue-700">16:9</span>
                        </div>
                        <select id="input-aspect" class="w-full bg-slate-700 text-white px-3 py-2 rounded text-xs font-bold">
                            <option value="16:9">16:9 (Standard)</option>
                            <option value="3:1">3:1 (Ultra Wide)</option>
                            <option value="2.39:1">2.39:1 (Cinemascope)</option>
                            <option value="1.85:1">1.85:1 (Theatrical)</option>
                            <option value="4:3">4:3 (Classic)</option>
                        </select>
                    </div>
                </div>

                <!-- Record & Photo Controls -->
                <div class="w-full space-y-3 pt-4 border-t border-slate-400">
                    <div class="text-xs text-slate-900 font-black uppercase text-center mb-2">Recording Controls</div>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-photo" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-3.5 rounded-lg uppercase tracking-widest shadow-md transition flex items-center justify-center gap-2">
                            <span>üì∑</span> Photo
                        </button>
                        <button id="btn-record" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-3.5 rounded-lg uppercase tracking-widest shadow-md transition flex items-center justify-center gap-2">
                            <span id="record-icon">‚è∫</span> <span id="record-text">Record</span>
                        </button>
                    </div>
                </div>

                <!-- Presets -->
                <div class="w-full space-y-2 pt-4 border-t border-slate-400">
                    <div class="text-xs text-slate-900 font-black uppercase text-center mb-2">Quick Presets</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="preset-btn border border-slate-600 text-xs py-2 rounded text-slate-900 hover:bg-slate-700 hover:text-white transition" data-preset="portrait">Portrait</button>
                        <button class="preset-btn border border-slate-600 text-xs py-2 rounded text-slate-900 hover:bg-slate-700 hover:text-white transition" data-preset="landscape">Landscape</button>
                        <button class="preset-btn border border-slate-600 text-xs py-2 rounded text-slate-900 hover:bg-slate-700 hover:text-white transition" data-preset="cinematic">Cinematic</button>
                        <button class="preset-btn border border-slate-600 text-xs py-2 rounded text-slate-900 hover:bg-slate-700 hover:text-white transition" data-preset="sports">Sports</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center">
            <div class="bg-gradient-to-br from-slate-900 to-black border-2 border-yellow-500 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                
                <!-- Header -->
                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-4 rounded-t-xl">
                    <h2 class="text-black font-black text-lg uppercase tracking-widest text-center">
                        ARRI ALEXA 35 - Advanced Settings
                    </h2>
                </div>

                <div class="p-6 space-y-6">
                    
                    <!-- Sensor Format -->
                    <div>
                        <label class="block text-yellow-500 text-xs font-black uppercase mb-3 tracking-wider">Sensor Format</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="sensor-format-btn bg-yellow-500 text-black py-3 px-4 rounded-lg font-bold uppercase text-sm hover:bg-yellow-400 transition" data-format="full">Full Frame</button>
                            <button class="sensor-format-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold uppercase text-sm hover:bg-slate-600 transition" data-format="super35">Super 35</button>
                        </div>
                    </div>

                    <!-- Exposure Index -->
                    <div>
                        <label class="block text-yellow-500 text-xs font-black uppercase mb-3 tracking-wider">Exposure Index</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button class="ei-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold text-sm hover:bg-slate-600 transition" data-ei="200">200</button>
                            <button class="ei-btn bg-yellow-500 text-black py-3 px-4 rounded-lg font-bold text-sm hover:bg-yellow-400 transition" data-ei="800">800</button>
                            <button class="ei-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold text-sm hover:bg-slate-600 transition" data-ei="1600">1600</button>
                        </div>
                    </div>

                    <!-- White Balance -->
                    <div>
                        <label class="block text-yellow-500 text-xs font-black uppercase mb-3 tracking-wider">White Balance</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="wb-btn bg-yellow-500 text-black py-3 px-4 rounded-lg font-bold text-sm hover:bg-yellow-400 transition" data-wb="5600">5600 K</button>
                            <button class="wb-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold text-sm hover:bg-slate-600 transition" data-wb="3200">3200 K</button>
                        </div>
                    </div>

                    <!-- Shutter Angle -->
                    <div>
                        <label class="block text-yellow-500 text-xs font-black uppercase mb-3 tracking-wider">Shutter Angle</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="shutter-btn bg-yellow-500 text-black py-3 px-4 rounded-lg font-bold text-sm hover:bg-yellow-400 transition" data-shutter="180">180¬∞</button>
                            <button class="shutter-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold text-sm hover:bg-slate-600 transition" data-shutter="90">90¬∞</button>
                        </div>
                    </div>

                    <!-- Visual Aids Row 1 -->
                    <div>
                        <label class="block text-yellow-500 text-xs font-black uppercase mb-3 tracking-wider">Visual Aids</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="modal-false-color" class="visual-aid-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold uppercase text-sm hover:bg-slate-600 transition">False Color</button>
                            <button id="modal-zebra" class="visual-aid-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold uppercase text-sm hover:bg-slate-600 transition">Zebras</button>
                        </div>
                    </div>

                    <!-- Visual Aids Row 2 -->
                    <div class="grid grid-cols-2 gap-3">
                        <button id="modal-lut-preview" class="visual-aid-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold uppercase text-sm hover:bg-slate-600 transition">LUT Preview</button>
                        <button id="modal-desqueeze" class="visual-aid-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold uppercase text-sm hover:bg-slate-600 transition">Anamorphic Desqueeze</button>
                    </div>

                    <!-- Visual Aids Row 3 -->
                    <div class="grid grid-cols-2 gap-3">
                        <button id="modal-histogram" class="visual-aid-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold uppercase text-sm hover:bg-slate-600 transition">Histogram</button>
                        <button id="modal-waveform" class="visual-aid-btn bg-slate-700 text-white py-3 px-4 rounded-lg font-bold uppercase text-sm hover:bg-slate-600 transition">Waveform</button>
                    </div>

                    <!-- Close Button -->
                    <button id="close-settings" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-black py-4 rounded-lg uppercase tracking-widest text-sm transition mt-4">
                        Close Settings
                    </button>

                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CORE SETUP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let scene, camera, renderer, clock;
        let cameramanGroup, subjects = [], trees = [], rocks = [];
        let viewMode = '3rdPerson';
        let orbitControls;
        let composer, renderPass;

        const state = {
            focusDist: 25.0,
            aperture: 4.0,
            zoom: 50,
            iso: 100,
            shutterAngle: 180,
            shutterSpeed: 50, // 1/50 for 24fps at 180¬∞
            whiteBalance: 5600,
            isPeaking: false,
            isZebra: false,
            wheelAngle: 0,
            orbit: { phi: Math.PI / 2 - 0.4, theta: -Math.PI / 1.4, radius: 20 },
            look: { x: 0, y: 0 },
            timecode: { h: 0, m: 0, s: 0, f: 0 },
            sensorFormat: 'full',
            exposureIndex: 800,
            falseColor: false,
            lutPreview: false,
            anamorphicDesqueeze: false,
            showHistogram: true,
            showWaveform: false,
            isRecording: false,
            aspectRatio: '16:9' // Can be '16:9', '3:1', '2.39:1', etc.
        };

        const elements = {
            hud: document.getElementById('hud'),
            viewLabel: document.getElementById('view-label'),
            btnMode: document.getElementById('btn-mode'),
            focusControls: document.getElementById('focus-controls'),
            wheel: document.getElementById('ff-wheel'),
            wheelMark: document.getElementById('wheel-mark'),
            distLabel: document.getElementById('dist-label'),
            dofLabel: document.getElementById('dof-label'),
            focusPtr: document.getElementById('focus-ptr'),
            btnRack: document.getElementById('btn-rack'),
            btnAutofocus: document.getElementById('btn-autofocus'),
            btnPeak: document.getElementById('btn-peak'),
            btnZebra: document.getElementById('btn-zebra'),
            zebraOverlay: document.getElementById('zebra-overlay'),
            peakingCanvas: document.getElementById('peaking-canvas'),
            fstopVal: document.getElementById('val-fstop'),
            zoomVal: document.getElementById('val-zoom'),
            isoVal: document.getElementById('val-iso'),
            shutterVal: document.getElementById('val-shutter'),
            shutterSpeedVal: document.getElementById('val-shutter-speed'),
            wbVal: document.getElementById('val-wb'),
            aspectVal: document.getElementById('val-aspect'),
            inputFstop: document.getElementById('input-fstop'),
            inputZoom: document.getElementById('input-zoom'),
            inputIso: document.getElementById('input-iso'),
            inputShutter: document.getElementById('input-shutter'),
            inputShutterSpeed: document.getElementById('input-shutter-speed'),
            inputWb: document.getElementById('input-wb'),
            inputAspect: document.getElementById('input-aspect'),
            btnPhoto: document.getElementById('btn-photo'),
            btnRecord: document.getElementById('btn-record'),
            recordIcon: document.getElementById('record-icon'),
            recordText: document.getElementById('record-text'),
            tc: document.getElementById('tc'),
            histogram: document.getElementById('histogram'),
            fpsCounter: document.getElementById('fps-counter'),
            batteryLevel: document.getElementById('battery-level'),
            batteryPct: document.getElementById('battery-pct')
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.FogExp2(0x87ceeb, 0.0003);

            clock = new THREE.Clock();

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            updateCamera();

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            document.getElementById('canvas-wrap').prepend(renderer.domElement);

            // Lighting
            const sun = new THREE.DirectionalLight(0xfff5e6, 1.5);
            sun.position.set(-60, 100, -40);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 2048;
            sun.shadow.mapSize.height = 2048;
            sun.shadow.camera.left = -50;
            sun.shadow.camera.right = 50;
            sun.shadow.camera.top = 50;
            sun.shadow.camera.bottom = -50;
            scene.add(sun);

            const ambient = new THREE.AmbientLight(0xb8d4ff, 0.6);
            scene.add(ambient);

            const hemi = new THREE.HemisphereLight(0x87ceeb, 0x3a6a3a, 0.4);
            scene.add(hemi);

            // Ground with texture-like appearance
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(2000, 2000, 50, 50),
                new THREE.MeshStandardMaterial({ 
                    color: 0x4a7c4a, 
                    roughness: 0.95,
                    metalness: 0.0
                })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Add ground variation
            const positions = ground.geometry.attributes.position;
            for (let i = 0; i < positions.count; i++) {
                positions.setZ(i, Math.random() * 0.3);
            }
            positions.needsUpdate = true;
            ground.geometry.computeVertexNormals();

            createEnvironment();
            cameramanGroup = createCinemaRig(0, 0);
            createHumanoid(0, 25, 0xffffff, 'actor1'); // 25 feet away
            createHumanoid(-8, 32, 0x224466, 'actor2'); // 32 feet away
            createHumanoid(10, 35, 0xaa3344, 'actor3'); // 35 feet away

            setupControls();
            setupHistogram();
            animate();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SCENE BUILDING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function createEnvironment() {
            // Trees
            for (let i = 0; i < 180; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = 25 + Math.random() * 140;
                const x = Math.cos(angle) * r;
                const z = Math.sin(angle) * r;

                const group = new THREE.Group();
                
                const trunkHeight = 8 + Math.random() * 5;
                const trunk = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.3 + Math.random() * 0.2, 0.5 + Math.random() * 0.2, trunkHeight, 8),
                    new THREE.MeshStandardMaterial({ 
                        color: 0x4a3728,
                        roughness: 0.9
                    })
                );
                trunk.castShadow = true;
                trunk.receiveShadow = true;
                trunk.position.y = trunkHeight / 2;

                const crownSize = 3.5 + Math.random() * 2.5;
                const crown = new THREE.Mesh(
                    new THREE.SphereGeometry(crownSize, 10, 10),
                    new THREE.MeshStandardMaterial({ 
                        color: 0x2d5a2d,
                        roughness: 1.0
                    })
                );
                crown.castShadow = true;
                crown.position.y = trunkHeight + crownSize * 0.6;

                group.add(trunk, crown);
                group.position.set(x, 0, z);
                scene.add(group);
                trees.push(group);
            }

            // Buildings behind trees
            createBuildings();

            // Rocks
            for (let i = 0; i < 40; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = 5 + Math.random() * 60;
                const x = Math.cos(angle) * r;
                const z = Math.sin(angle) * r;

                const rock = new THREE.Mesh(
                    new THREE.SphereGeometry(0.5 + Math.random() * 1.2, 6, 6),
                    new THREE.MeshStandardMaterial({ 
                        color: 0x666666,
                        roughness: 0.95,
                        metalness: 0.1
                    })
                );
                rock.position.set(x, (0.5 + Math.random() * 1.2) * 0.4, z);
                rock.rotation.set(Math.random(), Math.random(), Math.random());
                rock.castShadow = true;
                rock.receiveShadow = true;
                rock.scale.set(1, 0.6 + Math.random() * 0.4, 1);
                scene.add(rock);
                rocks.push(rock);
            }

            // Grass patches
            for (let i = 0; i < 60; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * 40;
                const x = Math.cos(angle) * r;
                const z = Math.sin(angle) * r;

                const grassPatch = new THREE.Mesh(
                    new THREE.CircleGeometry(1 + Math.random() * 2, 8),
                    new THREE.MeshStandardMaterial({ 
                        color: 0x3d7a3d,
                        roughness: 1.0,
                        side: THREE.DoubleSide
                    })
                );
                grassPatch.rotation.x = -Math.PI / 2;
                grassPatch.position.set(x, 0.02, z);
                grassPatch.receiveShadow = true;
                scene.add(grassPatch);
            }
        }

        function createBuildings() {
            const buildingConfigs = [
                // North side - Office district
                { x: -120, z: -180, width: 30, height: 45, depth: 25, color: 0x8b9dc3 },
                { x: -85, z: -190, width: 25, height: 60, depth: 20, color: 0xa8b5c7 },
                { x: -45, z: -175, width: 35, height: 40, depth: 30, color: 0x7a8a9f },
                { x: -10, z: -185, width: 28, height: 52, depth: 24, color: 0x929faf },
                { x: 25, z: -195, width: 32, height: 48, depth: 26, color: 0x8693a8 },
                { x: 50, z: -185, width: 28, height: 55, depth: 22, color: 0x95a3b8 },
                { x: 90, z: -170, width: 32, height: 50, depth: 28, color: 0x8895aa },
                { x: 130, z: -195, width: 26, height: 65, depth: 24, color: 0xa1aec2 },
                { x: 165, z: -180, width: 30, height: 42, depth: 25, color: 0x7d8fa4 },
                
                // South side - Residential area
                { x: -160, z: 160, width: 20, height: 30, depth: 18, color: 0xc4a57b },
                { x: -130, z: 175, width: 22, height: 35, depth: 20, color: 0xb89968 },
                { x: -95, z: 165, width: 18, height: 28, depth: 16, color: 0xd4b896 },
                { x: -65, z: 180, width: 24, height: 32, depth: 19, color: 0xc9a87d },
                { x: -30, z: 170, width: 20, height: 30, depth: 18, color: 0xb89d72 },
                { x: 5, z: 185, width: 22, height: 34, depth: 20, color: 0xd1b388 },
                { x: 40, z: 175, width: 21, height: 31, depth: 17, color: 0xc2a479 },
                { x: 70, z: 190, width: 23, height: 36, depth: 21, color: 0xbca074 },
                { x: 100, z: 170, width: 24, height: 32, depth: 19, color: 0xc9ad7f },
                { x: 140, z: 180, width: 21, height: 38, depth: 17, color: 0xb5a076 },
                { x: 170, z: 165, width: 26, height: 33, depth: 22, color: 0xddc29a },
                
                // East side - Mixed use
                { x: 175, z: -140, width: 28, height: 46, depth: 24, color: 0x8f9cb1 },
                { x: 185, z: -100, width: 30, height: 50, depth: 26, color: 0x97a4b9 },
                { x: 190, z: -60, width: 26, height: 44, depth: 22, color: 0x8a97ac },
                { x: 195, z: -20, width: 32, height: 52, depth: 28, color: 0x9ba8bd },
                { x: 200, z: 20, width: 28, height: 50, depth: 24, color: 0x8799ae },
                { x: 190, z: 60, width: 30, height: 48, depth: 26, color: 0x93a0b5 },
                { x: 185, z: 100, width: 26, height: 45, depth: 22, color: 0x8e9bb0 },
                { x: 180, z: 135, width: 28, height: 42, depth: 24, color: 0x9aa7bc },
                
                // West side - Commercial
                { x: -180, z: -135, width: 26, height: 44, depth: 22, color: 0x91a3b8 },
                { x: -190, z: -95, width: 28, height: 48, depth: 24, color: 0x8c9eb3 },
                { x: -195, z: -55, width: 24, height: 42, depth: 20, color: 0x97a9be },
                { x: -200, z: -15, width: 30, height: 50, depth: 26, color: 0x8a9cb1 },
                { x: -200, z: 25, width: 28, height: 46, depth: 24, color: 0x9aa8bd },
                { x: -195, z: 65, width: 26, height: 44, depth: 22, color: 0x8d9fb4 },
                { x: -185, z: 105, width: 30, height: 48, depth: 26, color: 0x92a4b9 },
                { x: -175, z: 140, width: 24, height: 40, depth: 20, color: 0x95a7bc },
                
                // Central tall buildings
                { x: 0, z: -200, width: 40, height: 70, depth: 35, color: 0x7f8fa4 },
                { x: -200, z: 0, width: 30, height: 45, depth: 25, color: 0x9aa8bd },
                { x: 200, z: 0, width: 28, height: 50, depth: 24, color: 0x8799ae },
                
                // Fill corner gaps
                { x: -150, z: -150, width: 25, height: 38, depth: 22, color: 0x96a3b8 },
                { x: 150, z: -150, width: 27, height: 40, depth: 24, color: 0x8f9cb1 },
                { x: -150, z: 150, width: 23, height: 36, depth: 20, color: 0xc7ab81 },
                { x: 150, z: 150, width: 25, height: 34, depth: 22, color: 0xc3a77d },
            ];

            buildingConfigs.forEach(config => {
                const building = new THREE.Group();
                
                // Main building body
                const body = new THREE.Mesh(
                    new THREE.BoxGeometry(config.width, config.height, config.depth),
                    new THREE.MeshStandardMaterial({ 
                        color: config.color,
                        roughness: 0.7,
                        metalness: 0.2
                    })
                );
                body.position.y = config.height / 2;
                body.castShadow = true;
                body.receiveShadow = true;
                building.add(body);

                // Windows
                const windowRows = Math.floor(config.height / 4);
                const windowCols = Math.floor(config.width / 3);
                
                for (let row = 0; row < windowRows; row++) {
                    for (let col = 0; col < windowCols; col++) {
                        // Front windows
                        const windowFront = new THREE.Mesh(
                            new THREE.PlaneGeometry(1.5, 2),
                            new THREE.MeshStandardMaterial({ 
                                color: Math.random() > 0.3 ? 0xfff9e6 : 0x2a2a2a,
                                emissive: Math.random() > 0.3 ? 0xffddaa : 0x000000,
                                emissiveIntensity: 0.3
                            })
                        );
                        windowFront.position.set(
                            -config.width / 2 + 3 + col * 3,
                            4 + row * 4,
                            config.depth / 2 + 0.01
                        );
                        building.add(windowFront);

                        // Back windows
                        const windowBack = new THREE.Mesh(
                            new THREE.PlaneGeometry(1.5, 2),
                            new THREE.MeshStandardMaterial({ 
                                color: Math.random() > 0.3 ? 0xfff9e6 : 0x2a2a2a,
                                emissive: Math.random() > 0.3 ? 0xffddaa : 0x000000,
                                emissiveIntensity: 0.3
                            })
                        );
                        windowBack.position.set(
                            -config.width / 2 + 3 + col * 3,
                            4 + row * 4,
                            -config.depth / 2 - 0.01
                        );
                        windowBack.rotation.y = Math.PI;
                        building.add(windowBack);
                    }
                }

                // Rooftop elements
                if (Math.random() > 0.5) {
                    const rooftop = new THREE.Mesh(
                        new THREE.BoxGeometry(config.width * 0.3, 3, config.depth * 0.3),
                        new THREE.MeshStandardMaterial({ 
                            color: 0x555555,
                            roughness: 0.8
                        })
                    );
                    rooftop.position.y = config.height + 1.5;
                    building.add(rooftop);
                }

                building.position.set(config.x, 0, config.z);
                scene.add(building);
            });

            // Add many more smaller shops/stores around the park perimeter
            for (let i = 0; i < 24; i++) {
                const angle = (i / 24) * Math.PI * 2;
                const r = 80 + Math.random() * 15;
                const x = Math.cos(angle) * r;
                const z = Math.sin(angle) * r;

                const shop = new THREE.Mesh(
                    new THREE.BoxGeometry(8, 6, 6),
                    new THREE.MeshStandardMaterial({ 
                        color: [0xe8d4b8, 0xc4a57b, 0xd4b896, 0xddc29a][Math.floor(Math.random() * 4)],
                        roughness: 0.8
                    })
                );
                shop.position.set(x, 3, z);
                shop.lookAt(0, 3, 0);
                shop.castShadow = true;
                shop.receiveShadow = true;
                scene.add(shop);

                // Awning
                const awning = new THREE.Mesh(
                    new THREE.BoxGeometry(9, 0.2, 2.5),
                    new THREE.MeshStandardMaterial({ 
                        color: [0xff6b6b, 0x4ecdc4, 0xffe66d, 0x95e1d3][Math.floor(Math.random() * 4)]
                    })
                );
                awning.position.set(x, 4.5, z);
                awning.lookAt(0, 4.5, 0);
                const awningForward = new THREE.Vector3(0, 0, 1);
                awningForward.applyQuaternion(awning.quaternion);
                awning.position.add(awningForward.multiplyScalar(3.5));
                scene.add(awning);
            }

            // Add medium buildings to fill remaining gaps
            const mediumBuildings = [
                { x: -110, z: -110, width: 18, height: 35, depth: 16 },
                { x: -110, z: 110, width: 18, height: 32, depth: 16 },
                { x: 110, z: -110, width: 18, height: 36, depth: 16 },
                { x: 110, z: 110, width: 18, height: 33, depth: 16 },
                { x: -70, z: -70, width: 15, height: 28, depth: 14 },
                { x: -70, z: 70, width: 15, height: 30, depth: 14 },
                { x: 70, z: -70, width: 15, height: 29, depth: 14 },
                { x: 70, z: 70, width: 15, height: 31, depth: 14 },
            ];

            mediumBuildings.forEach(config => {
                const building = new THREE.Mesh(
                    new THREE.BoxGeometry(config.width, config.height, config.depth),
                    new THREE.MeshStandardMaterial({ 
                        color: Math.random() > 0.5 ? 0x95a3b8 : 0xc4a57b,
                        roughness: 0.75
                    })
                );
                building.position.set(config.x, config.height / 2, config.z);
                building.castShadow = true;
                scene.add(building);
            });
        }

        function createHumanoid(x, z, color, id) {
            const g = new THREE.Group();
            const skin = new THREE.MeshStandardMaterial({ color: 0xffd9b3, roughness: 0.8 });
            const cloth = new THREE.MeshStandardMaterial({ color, roughness: 0.7 });

            const torso = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.9, 0.35), cloth);
            torso.position.y = 1.45;
            torso.castShadow = true;
            g.add(torso);

            const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 16, 16), skin);
            head.position.y = 2.0;
            head.castShadow = true;
            g.add(head);

            const leg = new THREE.BoxGeometry(0.22, 1.1, 0.22);
            const lLeg = new THREE.Mesh(leg, cloth);
            lLeg.position.set(-0.15, 0.55, 0);
            lLeg.castShadow = true;
            const rLeg = new THREE.Mesh(leg, cloth);
            rLeg.position.set(0.15, 0.55, 0);
            rLeg.castShadow = true;
            g.add(lLeg, rLeg);

            const arm = new THREE.BoxGeometry(0.18, 0.85, 0.18);
            const lArm = new THREE.Mesh(arm, skin);
            lArm.position.set(-0.42, 1.45, 0);
            lArm.castShadow = true;
            const rArm = new THREE.Mesh(arm, skin);
            rArm.position.set(0.42, 1.45, 0);
            rArm.castShadow = true;
            g.add(lArm, rArm);

            g.position.set(x, 0, z);
            g.lookAt(0, 1.5, 0);
            g.castShadow = true;
            scene.add(g);

            subjects.push({ 
                mesh: g, 
                pos: new THREE.Vector3(x, 1.6, z),
                id: id,
                leftArm: lArm,
                rightArm: rArm
            });
        }

        function createCinemaRig(x, z) {
            const rig = new THREE.Group();
            const black = new THREE.MeshStandardMaterial({ 
                color: 0x0a0a0a,
                roughness: 0.4,
                metalness: 0.6
            });
            const metal = new THREE.MeshStandardMaterial({ 
                color: 0x2a2a2a, 
                metalness: 0.8, 
                roughness: 0.2
            });

            // Tripod legs
            for (let i = 0; i < 3; i++) {
                const leg = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.05, 0.03, 1.8, 8),
                    black
                );
                const angle = i * Math.PI * 2 / 3;
                leg.position.set(Math.cos(angle) * 0.6, 0.9, Math.sin(angle) * 0.6);
                leg.rotation.z = Math.cos(angle) * 0.3;
                leg.rotation.x = Math.sin(angle) * 0.3;
                leg.castShadow = true;
                rig.add(leg);
            }

            // Camera body
            const body = new THREE.Mesh(
                new THREE.BoxGeometry(0.45, 0.45, 0.7),
                black
            );
            body.position.y = 1.65;
            body.castShadow = true;
            rig.add(body);

            // Lens
            const lens = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.15, 0.5, 20),
                black
            );
            lens.rotation.x = Math.PI / 2;
            lens.position.set(0, 1.65, 0.35);
            lens.castShadow = true;
            rig.add(lens);

            // Matte box
            const matte = new THREE.Mesh(
                new THREE.BoxGeometry(0.55, 0.45, 0.15),
                metal
            );
            matte.position.set(0, 1.65, 0.6);
            matte.castShadow = true;
            rig.add(matte);

            // Monitor
            const monitor = new THREE.Mesh(
                new THREE.BoxGeometry(0.4, 0.25, 0.05),
                new THREE.MeshStandardMaterial({ color: 0x1a1a1a })
            );
            monitor.position.set(0.3, 1.9, -0.1);
            monitor.rotation.y = -0.3;
            rig.add(monitor);

            rig.position.set(x, 0, z);
            scene.add(rig);
            return rig;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CAMERA & CONTROLS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function updateCamera() {
            if (viewMode === '3rdPerson') {
                const { phi, theta, radius } = state.orbit;
                camera.position.x = radius * Math.sin(phi) * Math.sin(theta);
                camera.position.y = radius * Math.cos(phi) + 1.8;
                camera.position.z = radius * Math.sin(phi) * Math.cos(theta);
                camera.lookAt(0, 1.6, 0);
                camera.fov = 50;
            } else {
                camera.position.set(0, 1.65, 0.15);
                camera.rotation.set(state.look.x, state.look.y, 0, 'YXZ');
                camera.fov = 90 - (state.zoom - 16) * 0.4; // More realistic FOV mapping
            }
            camera.updateProjectionMatrix();
        }

        function setupControls() {
            let isDragging = false;
            let lastX, lastY;

            const onDown = (e) => {
                if (e.target.closest('.interactive-area, #focus-controls')) return;
                isDragging = true;
                lastX = e.clientX ?? e.touches?.[0].clientX;
                lastY = e.clientY ?? e.touches?.[0].clientY;
            };

            const onMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.clientX ?? e.touches?.[0].clientX;
                const y = e.clientY ?? e.touches?.[0].clientY;
                const dx = x - lastX;
                const dy = y - lastY;

                if (viewMode === '3rdPerson') {
                    state.orbit.theta -= dx * 0.005;
                    state.orbit.phi = Math.max(0.1, Math.min(Math.PI / 2 - 0.05, state.orbit.phi - dy * 0.005));
                } else {
                    state.look.y -= dx * 0.003;
                    state.look.x = Math.max(-1.4, Math.min(1.4, state.look.x - dy * 0.003));
                }

                lastX = x;
                lastY = y;
                updateCamera();
            };

            const onUp = () => isDragging = false;

            renderer.domElement.addEventListener('mousedown', onDown);
            renderer.domElement.addEventListener('touchstart', onDown, { passive: false });
            window.addEventListener('mousemove', onMove);
            window.addEventListener('touchmove', onMove, { passive: false });
            window.addEventListener('mouseup', onUp);
            window.addEventListener('touchend', onUp);

            // Zoom control
            window.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (viewMode === '1stPerson') {
                    state.zoom = Math.max(16, Math.min(200, state.zoom - Math.sign(e.deltaY) * 2));
                    elements.inputZoom.value = state.zoom;
                    elements.zoomVal.textContent = `${Math.round(state.zoom)}mm`;
                    updateCamera();
                } else {
                    state.orbit.radius = Math.max(5, Math.min(100, state.orbit.radius + e.deltaY * 0.04));
                    updateCamera();
                }
            }, { passive: false });

            setupFollowFocusWheel();
            setupModeSwitch();
            setupCameraControls();
            setupPresets();
            setupAdvancedSettings();
        }

        function setupFollowFocusWheel() {
            let wheelDragging = false;
            let startAngle = 0, baseAngle = 0;

            const onWheelDown = (e) => {
                wheelDragging = true;
                const rect = elements.wheel.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                const clientX = e.clientX ?? e.touches?.[0].clientX;
                const clientY = e.clientY ?? e.touches?.[0].clientY;
                startAngle = Math.atan2(clientY - cy, clientX - cx);
                baseAngle = state.wheelAngle;
                e.preventDefault();
            };

            const onWheelMove = (e) => {
                if (!wheelDragging) return;
                e.preventDefault();
                const rect = elements.wheel.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                const clientX = e.clientX ?? e.touches?.[0].clientX;
                const clientY = e.clientY ?? e.touches?.[0].clientY;
                const angle = Math.atan2(clientY - cy, clientX - cx);
                let diff = (angle - startAngle) * (180 / Math.PI);
                
                // Handle angle wrapping
                if (diff > 180) diff -= 360;
                if (diff < -180) diff += 360;
                
                state.wheelAngle = baseAngle + diff;
                elements.wheelMark.style.transform = `translateX(-50%) rotate(${state.wheelAngle}deg)`;

                // Map wheel rotation to focus distance (0.5m to 50m, default 25m)
                state.focusDist = Math.max(0.5, Math.min(50, 25 + state.wheelAngle * 0.05));
                updateFocusDisplay();
            };

            const onWheelUp = () => wheelDragging = false;

            elements.wheel.addEventListener('mousedown', onWheelDown);
            elements.wheel.addEventListener('touchstart', onWheelDown, { passive: false });
            window.addEventListener('mousemove', onWheelMove);
            window.addEventListener('touchmove', onWheelMove, { passive: false });
            window.addEventListener('mouseup', onWheelUp);
            window.addEventListener('touchend', onWheelUp);
        }

        function setupModeSwitch() {
            const parkModeLabel = document.getElementById('park-mode-label');
            const cameramanModeLabel = document.getElementById('cameraman-mode-label');

            elements.btnMode.onclick = () => {
                if (viewMode === '3rdPerson') {
                    viewMode = '1stPerson';
                    elements.btnMode.textContent = 'Exit Cameraman Mode';
                    parkModeLabel.classList.add('hidden');
                    cameramanModeLabel.classList.remove('hidden');
                    elements.hud.style.display = 'block';
                    elements.focusControls.classList.remove('hidden');
                    cameramanGroup.visible = false;
                    state.look = { x: 0, y: 0 };
                } else {
                    viewMode = '3rdPerson';
                    elements.btnMode.textContent = 'Enter Cameraman Mode';
                    parkModeLabel.classList.remove('hidden');
                    cameramanModeLabel.classList.add('hidden');
                    elements.hud.style.display = 'none';
                    elements.focusControls.classList.add('hidden');
                    cameramanGroup.visible = true;
                    renderer.domElement.style.filter = 'none';
                    renderer.domElement.style.transform = 'scaleX(1)';
                }
                updateCamera();
            };
        }

        function setupCameraControls() {
            // Aperture
            elements.inputFstop.oninput = (e) => {
                state.aperture = parseFloat(e.target.value);
                elements.fstopVal.textContent = `f/${state.aperture.toFixed(1)}`;
                updateFocusDisplay();
            };

            // Zoom/Focal Length
            elements.inputZoom.oninput = (e) => {
                state.zoom = parseInt(e.target.value);
                elements.zoomVal.textContent = `${state.zoom}mm`;
                if (viewMode === '1stPerson') updateCamera();
            };

            // ISO
            elements.inputIso.oninput = (e) => {
                state.iso = parseInt(e.target.value);
                elements.isoVal.textContent = state.iso;
                document.getElementById('iso-val').textContent = state.iso;
            };

            // Shutter Angle
            elements.inputShutter.oninput = (e) => {
                state.shutterAngle = parseInt(e.target.value);
                elements.shutterVal.textContent = `${state.shutterAngle}¬∞`;
                document.getElementById('shutter-val').textContent = state.shutterAngle;
            };

            // White Balance
            elements.inputWb.oninput = (e) => {
                state.whiteBalance = parseInt(e.target.value);
                elements.wbVal.textContent = `${state.whiteBalance}K`;
                document.getElementById('wb-val').textContent = state.whiteBalance;
            };

            // Shutter Speed
            elements.inputShutterSpeed.oninput = (e) => {
                state.shutterSpeed = parseInt(e.target.value);
                elements.shutterSpeedVal.textContent = `1/${state.shutterSpeed}`;
                
                // Update shutter angle based on shutter speed (for 24fps)
                // At 24fps, 180¬∞ = 1/48, so we calculate the angle
                const fps = 24;
                const angle = Math.round((1 / state.shutterSpeed) * fps * 360);
                state.shutterAngle = Math.min(360, Math.max(45, angle));
                elements.inputShutter.value = state.shutterAngle;
                elements.shutterVal.textContent = `${state.shutterAngle}¬∞`;
                document.getElementById('shutter-val').textContent = state.shutterAngle;
            };

            // Aspect Ratio
            elements.inputAspect.onchange = (e) => {
                state.aspectRatio = e.target.value;
                elements.aspectVal.textContent = state.aspectRatio;
                applyAspectRatio(state.aspectRatio);
            };

            // Photo Button
            elements.btnPhoto.onclick = () => {
                if (viewMode !== '1stPerson') return;
                
                // Flash effect
                const flash = document.createElement('div');
                flash.style.cssText = 'position:fixed;inset:0;background:white;z-index:9999;pointer-events:none;';
                document.body.appendChild(flash);
                
                setTimeout(() => flash.remove(), 100);
                
                // Take screenshot
                try {
                    renderer.domElement.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `photo_${Date.now()}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                    });
                } catch (err) {
                    console.log('Photo captured (download disabled in demo)');
                }
            };

            // Record Button
            elements.btnRecord.onclick = () => {
                if (viewMode !== '1stPerson') return;
                
                state.isRecording = !state.isRecording;
                
                if (state.isRecording) {
                    elements.btnRecord.classList.remove('bg-red-600', 'hover:bg-red-700');
                    elements.btnRecord.classList.add('bg-green-600', 'hover:bg-green-700');
                    elements.recordIcon.textContent = '‚èπ';
                    elements.recordText.textContent = 'Stop';
                    
                    // Show REC indicator
                    document.querySelector('.rec-dot').style.display = 'inline-block';
                    document.querySelector('.text-red-600').style.display = 'inline';
                    
                    // Reset timecode
                    state.timecode = { h: 0, m: 0, s: 0, f: 0 };
                } else {
                    elements.btnRecord.classList.remove('bg-green-600', 'hover:bg-green-700');
                    elements.btnRecord.classList.add('bg-red-600', 'hover:bg-red-700');
                    elements.recordIcon.textContent = '‚è∫';
                    elements.recordText.textContent = 'Record';
                }
            };

            // Rack Focus
            elements.btnRack.onclick = () => {
                const currentDist = state.focusDist;
                const target = currentDist < 15 ? 30 : 10;
                animateFocus(currentDist, target, 2000);
            };

            // Auto Focus
            elements.btnAutofocus.onclick = () => {
                if (subjects.length > 0) {
                    const targetPos = subjects[0].pos;
                    const distance = camera.position.distanceTo(targetPos);
                    animateFocus(state.focusDist, distance, 1200);
                }
            };

            // Peaking
            elements.btnPeak.onclick = () => {
                state.isPeaking = !state.isPeaking;
                elements.btnPeak.textContent = state.isPeaking ? 'Peaking OFF' : 'Peaking ON';
                elements.btnPeak.classList.toggle('bg-green-700', state.isPeaking);
                elements.btnPeak.classList.toggle('text-white', state.isPeaking);
                elements.peakingCanvas.classList.toggle('active', state.isPeaking);
            };

            // Zebra
            elements.btnZebra.onclick = () => {
                state.isZebra = !state.isZebra;
                elements.btnZebra.textContent = state.isZebra ? 'Zebras OFF' : 'Zebras ON';
                elements.btnZebra.classList.toggle('bg-yellow-600', state.isZebra);
                elements.btnZebra.classList.toggle('text-white', state.isZebra);
                elements.zebraOverlay.style.display = state.isZebra ? 'block' : 'none';
            };
        }

        function setupPresets() {
            const presets = {
                portrait: { aperture: 1.8, zoom: 85, iso: 100, shutter: 180, wb: 5000 },
                landscape: { aperture: 11, zoom: 24, iso: 100, shutter: 180, wb: 5600 },
                cinematic: { aperture: 2.8, zoom: 50, iso: 800, shutter: 180, wb: 4500 },
                sports: { aperture: 4, zoom: 135, iso: 1600, shutter: 90, wb: 5600 }
            };

            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.onclick = () => {
                    const preset = presets[btn.dataset.preset];
                    if (preset) {
                        state.aperture = preset.aperture;
                        state.zoom = preset.zoom;
                        state.iso = preset.iso;
                        state.shutterAngle = preset.shutter;
                        state.whiteBalance = preset.wb;

                        elements.inputFstop.value = preset.aperture;
                        elements.inputZoom.value = preset.zoom;
                        elements.inputIso.value = preset.iso;
                        elements.inputShutter.value = preset.shutter;
                        elements.inputWb.value = preset.wb;

                        elements.fstopVal.textContent = `f/${preset.aperture.toFixed(1)}`;
                        elements.zoomVal.textContent = `${preset.zoom}mm`;
                        elements.isoVal.textContent = preset.iso;
                        elements.shutterVal.textContent = `${preset.shutter}¬∞`;
                        elements.wbVal.textContent = `${preset.wb}K`;

                        document.getElementById('iso-val').textContent = preset.iso;
                        document.getElementById('shutter-val').textContent = preset.shutter;
                        document.getElementById('wb-val').textContent = preset.wb;

                        if (viewMode === '1stPerson') updateCamera();
                        updateFocusDisplay();
                    }
                };
            });
        }

        function setupAdvancedSettings() {
            const settingsModal = document.getElementById('settings-modal');
            const btnSettings = document.getElementById('btn-settings');
            const closeSettings = document.getElementById('close-settings');

            // Open/Close modal
            btnSettings.onclick = () => {
                settingsModal.classList.remove('hidden');
            };

            closeSettings.onclick = () => {
                settingsModal.classList.add('hidden');
            };

            // Click outside to close
            settingsModal.onclick = (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            };

            // Sensor Format
            document.querySelectorAll('.sensor-format-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.sensor-format-btn').forEach(b => {
                        b.classList.remove('bg-yellow-500', 'text-black');
                        b.classList.add('bg-slate-700', 'text-white');
                    });
                    btn.classList.remove('bg-slate-700', 'text-white');
                    btn.classList.add('bg-yellow-500', 'text-black');
                    state.sensorFormat = btn.dataset.format;
                    
                    // Adjust FOV based on sensor format
                    if (viewMode === '1stPerson') {
                        updateCamera();
                    }
                };
            });

            // Exposure Index
            document.querySelectorAll('.ei-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.ei-btn').forEach(b => {
                        b.classList.remove('bg-yellow-500', 'text-black');
                        b.classList.add('bg-slate-700', 'text-white');
                    });
                    btn.classList.remove('bg-slate-700', 'text-white');
                    btn.classList.add('bg-yellow-500', 'text-black');
                    
                    const ei = parseInt(btn.dataset.ei);
                    state.exposureIndex = ei;
                    state.iso = ei;
                    elements.inputIso.value = ei;
                    elements.isoVal.textContent = ei;
                    document.getElementById('iso-val').textContent = ei;
                };
            });

            // White Balance Presets
            document.querySelectorAll('.wb-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.wb-btn').forEach(b => {
                        b.classList.remove('bg-yellow-500', 'text-black');
                        b.classList.add('bg-slate-700', 'text-white');
                    });
                    btn.classList.remove('bg-slate-700', 'text-white');
                    btn.classList.add('bg-yellow-500', 'text-black');
                    
                    const wb = parseInt(btn.dataset.wb);
                    state.whiteBalance = wb;
                    elements.inputWb.value = wb;
                    elements.wbVal.textContent = `${wb}K`;
                    document.getElementById('wb-val').textContent = wb;
                };
            });

            // Shutter Angle Presets
            document.querySelectorAll('.shutter-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.shutter-btn').forEach(b => {
                        b.classList.remove('bg-yellow-500', 'text-black');
                        b.classList.add('bg-slate-700', 'text-white');
                    });
                    btn.classList.remove('bg-slate-700', 'text-white');
                    btn.classList.add('bg-yellow-500', 'text-black');
                    
                    const shutter = parseInt(btn.dataset.shutter);
                    state.shutterAngle = shutter;
                    elements.inputShutter.value = shutter;
                    elements.shutterVal.textContent = `${shutter}¬∞`;
                    document.getElementById('shutter-val').textContent = shutter;
                };
            });

            // Visual Aids
            const visualAids = {
                'modal-false-color': 'falseColor',
                'modal-zebra': 'isZebra',
                'modal-lut-preview': 'lutPreview',
                'modal-desqueeze': 'anamorphicDesqueeze',
                'modal-histogram': 'showHistogram',
                'modal-waveform': 'showWaveform'
            };

            Object.entries(visualAids).forEach(([btnId, stateProp]) => {
                const btn = document.getElementById(btnId);
                btn.onclick = () => {
                    state[stateProp] = !state[stateProp];
                    
                    if (state[stateProp]) {
                        btn.classList.remove('bg-slate-700');
                        btn.classList.add('bg-green-600');
                    } else {
                        btn.classList.remove('bg-green-600');
                        btn.classList.add('bg-slate-700');
                    }

                    // Apply specific effects
                    if (stateProp === 'isZebra') {
                        elements.zebraOverlay.style.display = state.isZebra ? 'block' : 'none';
                    }
                    if (stateProp === 'showHistogram') {
                        elements.histogram.style.display = state.showHistogram ? 'block' : 'none';
                    }
                };
            });
        }

        function applyAspectRatio(ratio) {
            const hud = elements.hud;
            let topBottom = 38; // default border
            
            switch(ratio) {
                case '3:1':
                    topBottom = 200; // Much wider letterbox
                    break;
                case '2.39:1':
                    topBottom = 140;
                    break;
                case '1.85:1':
                    topBottom = 100;
                    break;
                case '4:3':
                    topBottom = 20;
                    break;
                case '16:9':
                default:
                    topBottom = 38;
                    break;
            }
            
            hud.style.borderTopWidth = `${topBottom}px`;
            hud.style.borderBottomWidth = `${topBottom}px`;
        }

        function animateFocus(start, target, duration) {
            const startTime = performance.now();
            
            function step(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease in-out cubic
                const eased = progress < 0.5 
                    ? 4 * progress * progress * progress 
                    : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                
                state.focusDist = start + (target - start) * eased;
                updateFocusDisplay();
                
                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }
            
            requestAnimationFrame(step);
        }

        function updateFocusDisplay() {
            elements.distLabel.textContent = state.focusDist.toFixed(1);
            elements.focusPtr.style.left = `${Math.min(100, (state.focusDist - 0.5) / 49.5 * 100)}%`;
            
            // Calculate depth of field
            const dof = calculateDoF(state.focusDist, state.aperture, state.zoom);
            elements.dofLabel.textContent = dof.toFixed(1);
        }

        function calculateDoF(distance, aperture, focalLength) {
            // Simplified DoF calculation
            const coc = 0.03; // Circle of confusion (mm)
            const distMm = distance * 1000;
            const H = (focalLength * focalLength) / (aperture * coc) + focalLength;
            
            const nearLimit = (H * distMm) / (H + (distMm - focalLength));
            const farLimit = (H * distMm) / (H - (distMm - focalLength));
            
            const dofRange = (farLimit - nearLimit) / 1000;
            return Math.min(dofRange, 99.9);
        }

        function setupHistogram() {
            // Create histogram bars
            for (let i = 0; i < 100; i++) {
                const bar = document.createElement('div');
                bar.className = 'histogram-bar';
                bar.style.left = `${i}%`;
                bar.style.height = '0%';
                elements.histogram.appendChild(bar);
            }
        }

        function updateHistogram() {
            // Simulate histogram based on scene brightness
            const bars = elements.histogram.querySelectorAll('.histogram-bar');
            bars.forEach((bar, i) => {
                const randomHeight = 20 + Math.random() * 60 + Math.sin(i * 0.1) * 20;
                bar.style.height = `${randomHeight}%`;
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ANIMATION LOOP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let lastTime = 0;
        let frameCount = 0;
        let fpsUpdateTime = 0;

        function animate(currentTime = 0) {
            requestAnimationFrame(animate);
            
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            // FPS counter
            frameCount++;
            fpsUpdateTime += deltaTime;
            if (fpsUpdateTime >= 1000) {
                const fps = (frameCount / fpsUpdateTime * 1000).toFixed(1);
                elements.fpsCounter.textContent = `${fps} fps`;
                frameCount = 0;
                fpsUpdateTime = 0;
            }

            const t = clock.getElapsedTime();

            // Animate trees (wind effect)
            trees.forEach((tree, i) => {
                const windStrength = 0.03;
                tree.rotation.z = Math.sin(t * 1.2 + i * 2) * windStrength;
                tree.rotation.x = Math.cos(t * 0.8 + i * 1.5) * windStrength;
            });

            // Animate actors (subtle movements)
            subjects.forEach((subject, i) => {
                const breathing = Math.sin(t * 2 + i) * 0.01;
                subject.mesh.position.y = breathing;
                
                // Arm sway
                if (subject.leftArm && subject.rightArm) {
                    subject.leftArm.rotation.z = Math.sin(t * 1.5 + i) * 0.1;
                    subject.rightArm.rotation.z = -Math.sin(t * 1.5 + i) * 0.1;
                }
            });

            // Timecode
            if (viewMode === '1stPerson' && state.isRecording) {
                state.timecode.f++;
                if (state.timecode.f >= 24) {
                    state.timecode.f = 0;
                    state.timecode.s++;
                }
                if (state.timecode.s >= 60) {
                    state.timecode.s = 0;
                    state.timecode.m++;
                }
                if (state.timecode.m >= 60) {
                    state.timecode.m = 0;
                    state.timecode.h++;
                }
                
                elements.tc.textContent = 
                    `${String(state.timecode.h).padStart(2, '0')}:` +
                    `${String(state.timecode.m).padStart(2, '0')}:` +
                    `${String(state.timecode.s).padStart(2, '0')}:` +
                    `${String(state.timecode.f).padStart(2, '0')}`;

                // Battery drain simulation
                if (Math.random() < 0.001) {
                    const current = parseInt(elements.batteryPct.textContent);
                    if (current > 0) {
                        const newVal = current - 1;
                        elements.batteryPct.textContent = `${newVal}%`;
                        elements.batteryLevel.style.width = `${newVal}%`;
                        
                        if (newVal < 20) {
                            elements.batteryLevel.classList.remove('bg-green-600');
                            elements.batteryLevel.classList.add('bg-red-600');
                        }
                    }
                }

                // Update histogram occasionally
                if (Math.floor(t * 2) % 5 === 0 && Math.random() < 0.1) {
                    updateHistogram();
                }

                // Apply depth of field effect
                applyDepthOfField();
            } else {
                renderer.domElement.style.filter = 'none';
            }

            renderer.render(scene, camera);
        }

        function applyDepthOfField() {
            if (!subjects.length) return;

            const targetPos = subjects[0].pos;
            const realDist = camera.position.distanceTo(targetPos);
            const focusError = Math.abs(realDist - state.focusDist);

            // Calculate blur amount based on aperture and focus error
            const blurIntensity = focusError * (20 / state.aperture) * (state.aperture < 4 ? 1.8 : 1.2);
            const blurPx = Math.min(blurIntensity, 35);

            // Adjust brightness based on ISO (using actual ISO value from state)
            const actualISO = state.iso; // Use the actual ISO from state
            const isoBrightness = 1.0 + (actualISO - 100) / 6400 * 0.8;

            // Adjust for shutter speed (faster shutter = darker)
            const shutterBrightness = Math.max(0.3, Math.min(2.0, 50 / state.shutterSpeed));

            // White balance tint
            let wbFilter = '';
            if (state.whiteBalance < 4000) {
                wbFilter = 'sepia(0.3) saturate(1.2)';
            } else if (state.whiteBalance > 7000) {
                wbFilter = 'hue-rotate(200deg) saturate(0.9)';
            }

            // Sensor format crop (affects FOV)
            const sensorCrop = state.sensorFormat === 'super35' ? 1.5 : 1.0;

            // False Color effect
            let falseColorFilter = '';
            if (state.falseColor) {
                falseColorFilter = 'hue-rotate(90deg) saturate(2) contrast(1.5)';
            }

            // LUT Preview effect (simulated film look)
            let lutFilter = '';
            if (state.lutPreview) {
                lutFilter = 'contrast(1.15) brightness(0.95) saturate(1.1) sepia(0.05)';
            }

            // Anamorphic Desqueeze (visual effect)
            if (state.anamorphicDesqueeze) {
                renderer.domElement.style.transform = 'scaleX(1.33)';
            } else {
                renderer.domElement.style.transform = 'scaleX(1)';
            }

            // Combine all effects
            const finalBrightness = isoBrightness * shutterBrightness;
            const filters = [
                `blur(${blurPx}px)`,
                `brightness(${finalBrightness})`,
                `contrast(${1.05 + (state.aperture > 8 ? 0.15 : 0)})`,
                wbFilter,
                falseColorFilter,
                lutFilter
            ].filter(Boolean).join(' ');

            renderer.domElement.style.filter = filters;

            // Peaking effect
            if (state.isPeaking) {
                const peakStrength = Math.max(0, 1 - focusError * 1.5);
                renderer.domElement.style.filter += ` saturate(${1 + peakStrength * 1.2}) brightness(${Math.min(finalBrightness * 1.1, 2.5)})`;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WINDOW RESIZE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function handleResize() {
            if (!camera || !renderer) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', handleResize);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // START APPLICATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.onload = init;

    </script>
</body>

</html>